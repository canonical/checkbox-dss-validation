job_queue: REPLACE_QUEUE
output_timeout: 1800
provision_data:
  REPLACE_PROVISION_DATA
test_data:
  test_cmds: |

    # Exit immediately if a test fails
    set -e

    # Clone repo from appropriate branch/commit.
    ssh ubuntu@$DEVICE_IP '
      DEBIAN_FRONTEND=noninteractive sudo apt -y install git
      git clone -b REPLACE_BRANCH \
        https://github.com/canonical/checkbox-dss-validation.git \
        ~ubuntu/checkbox-dss-validation
      cd ~ubuntu/checkbox-dss-validation
      echo "Current git branch: $(git branch --show-current)"
      echo "Latest commit:"
      git log --name-status HEAD^..HEAD
    '

    # Install snap
    ssh ubuntu@$DEVICE_IP '
      sudo snap install --classic snapcraft
      sudo snap install checkbox22
      sudo snap install lxd --channel=5.21/stable
      lxd init --auto
      cd checkbox-dss-validation
      snapcraft
      sudo snap install --dangerous --classic ./checkbox-dss_*_amd64.snap
    '

    # Install test dependencies
    ssh ubuntu@$DEVICE_IP '
      checkbox-dss.install-deps
    '

    # Run tests
    ssh ubuntu@$DEVICE_IP '
      checkbox-dss.validate-intel-gpu
    '
